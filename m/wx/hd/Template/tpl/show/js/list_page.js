define("com/mobile/page/milan/list_page.js",["$","./base_page.js","com/mobile/lib/storage/storage.js","com/mobile/lib/underscore/underscore.js","com/mobile/lib/widget/widget.js"],function(e,t){var a=e("com/mobile/lib/widget/widget.js"),i=e("./base_page.js"),o=e("com/mobile/lib/underscore/underscore.js"),n=e("$"),r=e("com/mobile/lib/storage/storage.js");n.extend(t,i),t.loadMore=a.define({events:{'tap [data-role="loadMore"]':function(){this.loadMore()},'touchend [data-role="loadMore"]':function(e){e.preventDefault()}},init:function(e){function t(){var e=n(window).scrollTop();n("body").height()-i-e<50&&a.loadMore()}var a=this,i=window.screen.height;this.render=o.template(n(e.template).html()),this.config=e,this.offset=0,this.scrollAble=e.scrollAble?e.scrollAble:!1,this.listening=!1,this.listenScroll=function(){a.listening||(a.listening=!0,n(window).on("scroll",t))},this.removeScrollListener=function(){n(window).off("scroll",t),a.listening=!1},e.scrollAble&&a.listenScroll()},loadMore:function(){var e=this;e.loading||(e.removeScrollListener(),e.loading=!0,e.getData(++e.offset,function(t,a){t?i.tip(t.message,1500):a&&0!==a.length?(e.config.$list.append(e.render({posts:a})),e.loading=!1,e.config.$loadMore.html("鏌ョ湅鏇村<i></i>"),e.config.scrollAble&&e.listenScroll()):e.config.$loadMore.html("娌℃湁鏇村浜�")}))},getData:function(e,t){var a=this;n.ajax({url:a.config.ajaxUrl,data:{offset:e,page:e+1},beforeSend:function(){a.config.$loadMore.html("鍔犺浇涓�...")},dataType:"json"}).done(function(e){t(null,e)}).fail(function(){t(new Error("network error!"))})}});var s=function(e){e||(e=window.location.search);var t,a={};return e=e.replace("?",""),t=e.split("&"),n.each(t,function(e,t){var i=t.split("=");2===i.length&&(a[i[0]]=decodeURIComponent(i[1]))}),a};t.listFilter=a.define({events:{'click [data-role="filterItem"]':"showFilterContent","tap [data-role=checkItem]":"toggleCheckItem","tap .js-sigle [data-ajax]":"showNextCate","tap .js-sigle [data-value]":"sigleUpdate",'tap [data-role="moreItem"] li':"showChildFilter",'tap [data-role="back"]':"backParentFilter","tap .js-more [data-ajax]":"showNextCate","tap .js-more [data-value]":"moreUpdate",'tap [data-role="reset"]':"resetFilter",'tap [data-role="submit"]':"submitFilter"},init:function(e){var t=this;this.config=e,this.$el=e.$el,this.$container=null,this.$mask=n("#maskEl"),this.curParams=s(),this.$mask.on("click",function(e){e.preventDefault(),t.hideFilterContent()}),this.noScroll=!1,n("body").on("touchmove",function(e){t.noScroll&&e.preventDefault()});var a=n("body").scrollTop();window.scrollTo(0,a+1);var i=navigator.userAgent.indexOf("iPhone OS 7")>-1;i||n(".filtate-outter").css("position","relative"),this.config.$moreChild&&this.config.$moreChild.length&&this.config.$moreChild.find(".js-filt-child").each(function(){var e=n(this),t={};e.find("[data-key]").each(function(){var e=n(this).data("key"),a=n(this).find(".active").data("value");a||(a=n(this).find(".active").data("ajax")),t[e]=a}),e.data("params",t)}),e.$el.on("touchstart","li",function(){n(this).addClass("touch")}).on("touchmove, touchcanel, touchend","li",function(){n(this).removeClass("touch")});var o=n(window).height()-130;this.maxHeight=41*(Math.round(o/41)-1),e.$el.find(".js-sigle .warpper").css("height",this.maxHeight),e.$moreItem&&(e.$moreItem.css("height",this.maxHeight),e.$moreItem.find(".warpper").css("height",this.maxHeight-43),e.$moreChild.find(".warpper").css("height",this.maxHeight-41))},initScroll:function(e){var t=n("#"+e);G.use("com/mobile/lib/iscroll/iscroll.js",function(){t.find(".warpper").each(function(){var e=this;n(this).data("hasScroll")||new window.IScroll(e,{bounceEasing:"easing",bounceTime:600,click:!0,scrollbars:!0,mouseWheel:!0,interactiveScrollbars:!0,shrinkScrollbars:"scale"}),n(this).data("hasScroll",!0)});var e=n("body").scrollTop();window.scrollTo(0,e+1)})},toggleCheckItem:function(e){var t=n(e.currentTarget);t.find("[data-week]").toggleClass("checked js-check")},showFilterContent:function(e){e.preventDefault(),this.noScroll=!0;var t=n(e.currentTarget);if(t.hasClass("active"))return this.hideFilterContent(),!1;var a=this.$el,i=t.data("id");if(this.$container=n("#"+i),n("body").addClass("body-filt-open"),this.config.$filterItem.removeClass("active"),a.find(".filt-open").removeClass("filt-show"),t.addClass("active"),this.$container.addClass("filt-show"),this.$mask.show(),n("#"+i).hasClass("js-more")){var o=this.config.$moreItem,r=o.find(".warpper");return G.use("com/mobile/lib/iscroll/iscroll.js",function(){r.length&&!r.data("hasScroll")&&(new window.IScroll(r[0],{bounceEasing:"easing",bounceTime:600,click:!0,scrollbars:!0,mouseWheel:!0,interactiveScrollbars:!0,shrinkScrollbars:"scale"}),r.data("hasScroll",!0))}),!1}var s=n("body").scrollTop();window.scrollTo(0,s+1),this.initScroll(i)},preventFilterContent:function(e){e.preventDefault()},showNextCate:function(e){e.preventDefault();var t=this,a=n(e.currentTarget);if(a.hasClass("active"))return!1;var i=a.parents(".warpper");i.find(".active").removeClass("active"),a.addClass("active");var o=i.next();if(o.length){o.find(".active").removeClass("active");for(var r=o.next();;){if(!r.length)break;r.remove(),r=o.next()}}var s="",l=i.parents(".filt-open").data("url"),c=a.data("ajax"),d=a.data("extra");d||(d={}),l=l.replace("{keyword}",c),n.getJSON(l,d,function(e){var a=e.key;if(e.data.length&&n.each(e.data,function(e,t){var a="";t.extra&&(a="data-extra='"+JSON.stringify(t.extra)+"'");var i="";t.default_name&&(i='data-name="'+t.default_name+'"'),s+=t.hasChild?"<li "+a+' data-ajax="'+t.id+'" '+i+"><a>"+t.name+'</a><i class="filt-arrow"></i></li>':"<li "+a+' data-value="'+t.id+'" '+i+"><a>"+t.name+"</a></li>"}),o.length)s="<ul>"+s+"</ul>",o.html(s).data("key",a).data("hasScroll",!1).show();else{var r=t.maxHeight;i.parents(".js-filt-child").length>0&&(r-=41);var l="bg-gray";i.closest(".filt-show").find(".warpper").length>1&&(l="bg-black"),s='<div style="height:'+r+'px" class="warpper box-flex1 '+l+'" data-key="'+a+'"><ul>'+s+"</ul></div>",i.after(s)}var c=i.parents(".filt-open").attr("id");t.initScroll(c)})},sigleUpdate:function(e){e.preventDefault();var t=n(e.currentTarget),a=t.parents(".js-sigle"),i=this,o=t.find('[type="checkbox"]');if(o.length){var r=o.prop("checked");o.prop("checked",!r)}for(var s=t.parents(".warpper"),l=s.next(),c=l;;){if(!c.length)break;c.hide(),c.find(".active").removeClass("active"),c=c.next()}t.parents("ul").find(".active").removeClass("active"),t.addClass("active");var d={};a.find("[data-key]").each(function(){var e=n(this).data("key"),t=n(this).find(".active").data("value"),a=n(this).find(".active").data("extra");a&&(d=n.extend(d,a)),(void 0===t||""===n.trim(t))&&(t=n(this).find(".active").data("ajax")),void 0===t||""===n.trim(t)?delete i.curParams[e]:d[e]=t});var h=a.data("reject");h&&h.length&&n.each(h,function(e,t){delete i.curParams[t]}),this.gotoUrl(d)},showChildFilter:function(e){e.preventDefault();var t=n(e.currentTarget),a=t.data("id");if(a)this.config.$moreChild.find(".js-filt-child").hide(),n("#"+a).show(),this.config.$moreItem.parent().animate({left:"-100%"},300,"ease-in-out"),this.initScroll(a);else{var i=t.data("curKey"),o=t.data("curValue");i&&void 0!==o&&(t.find(".js-check").hasClass("active")?(delete this.curParams[i],t.find(".js-check").removeClass("active")):(this.curParams[i]=o,t.find(".js-check").addClass("active")))}},moreUpdate:function(e){e.preventDefault();var t=n(e.currentTarget),a=this;if(t.hasClass("active"))return!1;for(var i=t.parents(".warpper"),o=i.next(),r=o;;){if(!r.length)break;r.hide(),r.find(".active").removeClass("active"),r=r.next()}var s=t.text();t.data("name")&&(s=t.data("name"));var l=t.parents(".js-filt-child");t.parents("ul").find(".active").removeClass("active"),t.addClass("active");var c=l.attr("id"),d=l.data("event"),h=l.data("refId");this.backParnentHandler(c,s);var f={};l.find("[data-key]").each(function(){var e=n(this).data("key"),t=n(this).find(".active").data("value"),i=n(this).find(".active").data("extra");i&&(f=n.extend(f,i)),(void 0===t||""===n.trim(t))&&(t=n(this).find(".active").data("ajax")),void 0===t||""===n.trim(t)?delete a.curParams[e]:f[e]=t,f[e]=t}),l.data("params",f);var u=l.data("reject");u&&u.length&&n.each(u,function(e,t){delete a.curParams[t]}),d&&n("#"+h).trigger(d,f)},backParentFilter:function(e){e.preventDefault(),this.backParnentHandler(null,null)},backParnentHandler:function(e,t){e&&t&&this.config.$moreItem.find('[data-id="'+e+'"]').find(".js-span").text(t),this.config.$moreItem.parent().animate({left:0},300,"ease-in-out")},hideFilterContent:function(){n("body").removeClass("body-filt-open"),this.config.$filterItem.removeClass("active"),this.$el.find(".filt-open").removeClass("filt-show"),this.$mask.hide(),this.noScroll=!1},resetFilter:function(e){e.preventDefault(),this.config.$moreItem.find(".js-span").each(function(){n(this).text("涓嶉檺")}),this.config.$moreItem.find(".js-check").each(function(){n(this).removeClass("active")}),this.curParams={},this.config.$moreChild.find(".js-filt-child").each(function(){var e={};n(this).find(".warpper").each(function(t){var a=n(this).data("key");n(this).data("defaultValue")&&(e[a]=n(this).data("defaultValue")),0===t?n(this).find(".active").removeClass("active"):n(this).remove()}),n(this).data("params",e)})},submitFilter:function(){var e={},t=this.config.$moreChild,a=this.config.$checkItem;if(t&&t.find(".js-filt-child").each(function(){var t=n(this).data("params");t=t||{},n.extend(e,t)}),a){var i="";a.find(".js-check").each(function(){i+=n(this).data("week")}),i&&(e.workday=i)}this.gotoUrl(e)},gotoUrl:function(e){e=n.extend({},this.curParams,e),e.page=1,delete e.ingore,delete e.ifid,window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")),window.location.href=window.location.pathname+"?"+n.param(e)}}),t.removeField=function(e){var t=n('#filter-more [data-id="filt-more-shoujihao_operator"]'),i=n('#filter-more [data-id="filt-more-shoujihao_feature"]');return t.length&&i.length?void a.ready(n(".list-filtrate"),function(a){e.$el.on("click","li",function(){var e=n(this).data("value");"shoujihaoma"===e?(t.show(),i.show(),n("#filt-more-shoujihao_operator").addClass("js-filt-child"),n("#filt-more-shoujihao_feature").addClass("js-filt-child")):(delete a.curParams.shoujihao_operator,delete a.curParams.shoujihao_feature,t.hide(),i.hide(),n("#filt-more-shoujihao_operator").removeClass("js-filt-child"),n("#filt-more-shoujihao_feature").removeClass("js-filt-child"))})}):!1},t.geoStatus=function(e){var t,a=e.$el,i=e.url,l="";i&&(i=i.replace(/#./,""),t=i.split("?"),l=t[0]);var c={};if(t&&t.length>1){var d=t[1];c=s(d)}if(e.lat&&e.lng){var h=e.lat+","+e.lng;n.getJSON("/latlng/?latlng="+h,function(t){var i=t.data.currentLocation;a.find(".tip1").hide(),e.$addressName.text(i),e.$agree.show()})}var f=new r("nearbyPos"),u=function(){var t=n.Deferred();t.done(function(t){a.find(".tip1").hide(),e.$checking.show(),o.extend(c,s()),c.lat=t.latitude,c.lng=t.longitude,window.location.href=window.location.pathname+"?"+n.param(c),setTimeout(function(){a.find(".tip1").hide(),e.$check.show()},1e3)}).fail(function(t){var i="";i=t.code===t.PERMISSION_DENIED?"娴忚鍣ㄥ畾浣嶆巿鏉冩湭鎵撳紑":t.code===t.POSITION_UNAVAILABLE?"瀹氫綅澶辫触":"瀹氫綅瓒呮椂",a.find(".tip1").hide(),e.$tip.text(i),e.$reject.show()}),a.find(".tip1").hide(),e.$checking.show();var i=f.get("curPos"),r=(new Date).getTime();!i||i&&r-i.curTime>18e6?(f.remove("curPos"),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){i={latitude:e.coords.latitude,longitude:e.coords.longitude,curTime:(new Date).getTime()},f.set("curPos",i),t.resolve(i)},function(e){t.reject(e)},{timeout:e.timeout||3e4,maximumAge:6e5,enableHighAccuracy:!0}):t.reject()):t.resolve(i)};e.$check.on("click",function(e){e.preventDefault(),u()}),e.$refresh.on("click",function(){f.remove("curPos"),u()})},t.initPage=function(e){var t=s(),a=function(){window.location.href=window.location.pathname+"?"+n.param(t)};n(e.$prev).on("click",function(e){return e.preventDefault(),n(this).hasClass("disable")?!1:(t.page?t.page-=1:t.page=1,void a())}),e.$select.on("change",function(){var e=n(this).val();window.location.href=e}).on("touchstart",function(){n(this).addClass("touch")}).on("touchend, touchmove, touchcancel",function(){n(this).removeClass("touch")}).on("touchstart, touchmove, touchend",function(e){e.stoppropagation()}),n(e.$next).on("click",function(){return n(this).hasClass("disable")?!1:(t.page?t.page+=1:t.page=1,void a())})},t.postList=function(e){if(e.$imState&&e.$imState.length){var t=[];e.$imState.each(function(){var e=n(this).data("userId");t.push(e)}),t=t.join(","),n.getJSON("http://webim.ganji.com/index.php?op=getuserstatuss&callback=?",{userIds:t},function(t){var a=t.data;a&&e.$imState.each(function(){var e=n(this).data("userId");a[e]&&a[e].status&&(n(this).addClass("online").show(),n(this).find("span").text("鍦ㄧ嚎"))})})}if(e.$img&&e.$img.length){e.$img.each(function(){var e=n(this).offset().top;n(this).data("offsetTop",e)});var a=n(window).height(),i=null,o=0,r=function(){clearTimeout(i),i=setTimeout(function(){var t=n(window).scrollTop();if(e.$img.each(function(e){var i=n(this).data("src");if(i){var r=n(this).data("offsetTop");if(!(t+a+300>r))return o=e,!1;n(this).attr("src",i),n(this).data("src","")}},0),e.$img=n(e.$img.toArray().splice(o)),1===e.$img.length){var i=e.$img.data("src");return e.$img.attr("src",i),n(window).off("scroll",r),!1}})};n(window).on("scroll",r)}},t.init=function(){i.init()}});